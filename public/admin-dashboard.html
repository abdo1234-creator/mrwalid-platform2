<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ± ÙˆÙ„ÙŠØ¯ | Premium Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
        }
        body { 
            font-family: 'Cairo', sans-serif; 
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: #f8fafc;
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255,255,255,0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-link {
            transition: 0.3s;
            border-radius: 12px;
            margin: 4px 12px;
        }
        .nav-link.active {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 24px;
        }
        .stat-card {
            transition: transform 0.3s;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
        }
        .stat-card:hover { transform: translateY(-5px); }
        .section { display: none; animation: fadeIn 0.5s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, select, textarea {
            background: rgba(15, 23, 42, 0.6) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: white !important;
            border-radius: 12px !important;
        }
        input:focus, textarea:focus { border-color: var(--primary) !important; outline: 2px solid var(--primary); outline-offset: 1px; }
        .custom-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .custom-table tr { background: rgba(30, 41, 59, 0.4); transition: 0.3s; }
        .custom-table tr:hover { background: rgba(30, 41, 59, 0.8); }
        .custom-table td, .custom-table th { padding: 16px; text-align: right; }
        .custom-table th { color: #94a3b8; font-weight: 400; }
        .custom-table td:first-child { border-radius: 0 12px 12px 0; }
        .custom-table td:last-child { border-radius: 12px 0 0 12px; }

        @media print { .sidebar, .no-print { display: none !important; } .main-content { margin: 0 !important; width: 100% !important; } }
        
        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .grade-tab.active { background: var(--primary); color: white; }
        .absent-tab.active { background: #ef4444; border-color: #f87171; }
    </style>
</head>
<body class="flex overflow-x-hidden">

    <aside class="sidebar fixed w-64 h-full z-50">
        <div class="p-8 text-center border-b border-white/5">
            <h2 class="text-4xl font-black mb-4">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø´Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ø¨Ø¯Ùˆ.. ğŸ‘‘</h2>
            <p class="text-xs text-slate-400 mt-2 italic">Ù„ÙˆØ­Ù‡ ØªØ­ÙƒÙ…Ùƒ ÙŠØ§ Ù‡Ù†Ø¯Ø³Ù‡</p>
        </div>
        
        <nav class="mt-8">
            <a onclick="show('home')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer active" id="btn-home">
                <i class="fas fa-home w-8"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
            <a onclick="show('add-lesson')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer" id="btn-add-lesson">
                <i class="fas fa-play-circle w-8"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø©
            </a>
            <a onclick="show('add-quiz')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer" id="btn-add-quiz">
                <i class="fas fa-question-circle w-8"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±
            </a>
            <a onclick="show('add-pdf')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer" id="btn-add-pdf">
                <i class="fas fa-file-pdf w-8"></i>  Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§ØªPDF
            </a>
            <a onclick="show('codes')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer" id="btn-codes">
                <i class="fas fa-ticket-alt w-8"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
            </a>
            <a onclick="show('students')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer" id="btn-students">
                <i class="fas fa-user-graduate w-8"></i> ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨
            </a>
            <a onclick="show('absent')" class="nav-link flex items-center p-4 text-slate-300 hover:text-white cursor-pointer" id="btn-absent">
                <i class="fas fa-user-times w-8"></i> ÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨
            </a>
            <div class="mt-20 border-t border-white/5 pt-4">
                <a onclick="logout()" class="nav-link flex items-center p-4 text-red-400 hover:bg-red-500/10 cursor-pointer">
                    <i class="fas fa-sign-out-alt w-8"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </nav>
    </aside>

    <main class="main-content flex-1 mr-64 p-8 min-h-screen">
        
        <div class="flex justify-between items-center mb-10 no-print">
            <div>
                <h1 id="page-title" class="text-3xl font-black text-white">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h1>
                <p id="current-date" class="text-indigo-400 text-sm mt-1"></p>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-indigo-500/10 border border-indigo-500/20 px-4 py-2 rounded-2xl flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold text-indigo-300">Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØµÙ„</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 no-print">
            <div class="stat-card glass-card p-6 flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-indigo-500/20 flex items-center justify-center text-indigo-400"><i class="fas fa-users text-xl"></i></div>
                <div><p class="text-slate-400 text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p><h3 id="stat-students" class="text-2xl font-black">0</h3></div>
            </div>
            <div class="stat-card glass-card p-6 flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-purple-500/20 flex items-center justify-center text-purple-400"><i class="fas fa-video text-xl"></i></div>
                <div><p class="text-slate-400 text-xs">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³</p><h3 id="stat-lessons" class="text-2xl font-black">0</h3></div>
            </div>
            <div class="stat-card glass-card p-6 flex items-center gap-4 border-b-4 border-green-500/30">
                <div class="w-12 h-12 rounded-2xl bg-green-500/20 flex items-center justify-center text-green-400"><i class="fas fa-check-circle text-xl"></i></div>
                <div><p class="text-slate-400 text-xs">Ø£ÙƒÙˆØ§Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø©</p><h3 id="stat-used" class="text-2xl font-black">0</h3></div>
            </div>
            <div class="stat-card glass-card p-6 flex items-center gap-4 border-b-4 border-orange-500/30">
                <div class="w-12 h-12 rounded-2xl bg-orange-500/20 flex items-center justify-center text-orange-400"><i class="fas fa-tags text-xl"></i></div>
                <div><p class="text-slate-400 text-xs">Ø£ÙƒÙˆØ§Ø¯ Ù…ØªØ§Ø­Ø©</p><h3 id="stat-available" class="text-2xl font-black">0</h3></div>
            </div>
        </div>

        <div id="home" class="section active">
            <div class="glass-card p-10 text-center mb-8 relative overflow-hidden">
                <div class="relative z-10">
                   <h2 class="text-2xl font-black">Ø¨Ø´Ù…Ù‡Ù†Ø¯Ø³ Ø¹Ø¨Ø¯Ùˆ ğŸ“</h2>
                    <p class="text-slate-400 max-w-xl mx-auto">Ù…Ù†ÙˆØ± Ù„ÙˆØ­Ù‡ Ø§Ù„ØªØ­ÙƒÙ… ÙŠØ§ Ù‡Ù†Ø¯Ø³Ù‡ </p>
                </div>
                <div class="absolute -right-20 -top-20 w-64 h-64 bg-indigo-600/10 rounded-full blur-3xl"></div>
            </div>
        </div>

        <div id="add-lesson" class="section">
            <div class="glass-card p-8 max-w-4xl mx-auto">
                <div class="flex items-center gap-4 mb-8">
                    <div class="p-3 bg-indigo-500/20 rounded-xl text-indigo-400"><i class="fas fa-plus-circle text-xl"></i></div>
                    <h2 class="text-2xl font-bold">Ù†Ø´Ø± Ù…Ø­Ø§Ø¶Ø±Ø© ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯Ø©</h2>
                </div>
                <form id="lessonForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select id="l-grade" class="w-full p-4">
                                <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©">
                                    <option value="1-prep">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                    <option value="2-prep">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                    <option value="3-prep">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                </optgroup>
                                <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©">
                                    <option value="1-sec">1 Ø«Ø§Ù†ÙˆÙŠ</option>
                                    <option value="2-sec">2 Ø«Ø§Ù†ÙˆÙŠ</option>
                                    <option value="3-sec">3 Ø«Ø§Ù†ÙˆÙŠ</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ù„Ø´Ù‡Ø±</label>
                            <select id="l-month" class="w-full p-4 month-selector"></select> 
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ù„ÙØ±Ø¹</label>
                            <select id="l-branch" class="w-full p-4">
                                <option value="Ø¬Ø¨Ø±">Ø¬Ø¨Ø±</option><option value="Ù‡Ù†Ø¯Ø³Ø©">Ù‡Ù†Ø¯Ø³Ø©</option><option value="Ø­Ø³Ø§Ø¨ Ù…Ø«Ù„Ø«Ø§Øª">Ø­Ø³Ø§Ø¨ Ù…Ø«Ù„Ø«Ø§Øª</option>
                                <option value="ØªÙØ§Ø¶Ù„">ØªÙØ§Ø¶Ù„</option><option value="Ø§Ø³ØªØ§ØªÙŠÙƒØ§">Ø§Ø³ØªØ§ØªÙŠÙƒØ§</option><option value="Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§">Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-slate-400 mr-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
                        <input type="text" id="l-title" class="w-full p-4" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø­Ù„ Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-slate-400 mr-2">Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Embed Link)</label>
                        <input type="text" id="l-video" class="w-full p-4 font-mono text-sm" placeholder="https://www.youtube.com/embed/...">
                    </div>
                    <button type="submit" id="l-btn" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl transition shadow-lg shadow-indigo-600/20">
                        <i class="fas fa-paper-plane ml-2"></i> Ù†Ø´Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†
                    </button>
                </form>
            </div>
        </div>

        <div id="add-quiz" class="section">
            <div class="glass-card p-8 max-w-4xl mx-auto">
                <div class="flex items-center gap-4 mb-8">
                    <div class="p-3 bg-purple-500/20 rounded-xl text-purple-400"><i class="fas fa-tasks text-xl"></i></div>
                    <h2 class="text-2xl font-bold">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¬Ø¯ÙŠØ¯</h2>
                </div>
                <form id="quizForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select id="q-grade" class="w-full p-4" onchange="updateLessonList('q')">
                                <option value="1-prep">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="2-prep">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="3-prep">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="1-sec">1 Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="2-sec">2 Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="3-sec">3 Ø«Ø§Ù†ÙˆÙŠ</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±</label>
                            <select id="q-month" class="w-full p-4 month-selector" onchange="updateLessonList('q')"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø±Ø¨Ø· Ø¨Ù…Ø­Ø§Ø¶Ø±Ø© (Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©)</label>
                            <select id="q-lesson" class="w-full p-4 lesson-loader">
                                <option value="standalone">Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù…Ù†ÙØµÙ„</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</label>
                            <input type="text" id="q-title" class="w-full p-4" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ø¯Ø±Ø³ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                            <input type="number" id="q-time" class="w-full p-4" placeholder="30">
                        </div>
                    </div>

                    <div class="border-t border-white/10 pt-6">
                        <h3 class="text-lg font-bold mb-4 text-indigo-400"><i class="fas fa-list-ol ml-2"></i> Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
                        <div id="questions-container" class="space-y-6"></div>
                        
                        <div class="mt-6 p-6 bg-white/5 rounded-2xl border border-dashed border-white/20">
                            <h4 class="text-sm font-bold mb-4 text-indigo-300">Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <textarea id="temp-q-text" class="w-full p-4" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." rows="2"></textarea>
                                <input type="text" id="temp-q-image" class="w-full p-4" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) - https://...">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <input type="text" id="temp-opt-0" class="p-3 text-sm" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ (A)">
                                <input type="text" id="temp-opt-1" class="p-3 text-sm" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ (B)">
                                <input type="text" id="temp-opt-2" class="p-3 text-sm" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø« (C)">
                                <input type="text" id="temp-opt-3" class="p-3 text-sm" placeholder="Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹ (D)">
                            </div>
                            <div class="grid grid-cols-1 gap-4 mb-4">
                                <textarea id="temp-q-explanation" class="w-full p-3 text-sm" placeholder="ØªÙØ³ÙŠØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù†Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø­Ù„Ù‡)..." rows="2"></textarea>
                            </div>
                            <div class="flex items-center gap-4">
                                <select id="temp-correct" class="flex-1 p-3 text-sm">
                                    <option value="">Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©...</option>
                                    <option value="0">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ (A)</option>
                                    <option value="1">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ (B)</option>
                                    <option value="2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø« (C)</option>
                                    <option value="3">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹ (D)</option>
                                </select>
                                <button type="button" onclick="addQuestionToQuiz()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-sm font-bold transition">
                                    <i class="fas fa-plus ml-2"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„
                                </button>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-4 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-2xl transition shadow-lg shadow-purple-600/20">
                        <i class="fas fa-save ml-2"></i> Ø­ÙØ¸ ÙˆÙ†Ø´Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                    </button>
                </form>
            </div>
        </div>

        <div id="add-pdf" class="section">
            <div class="glass-card p-8 max-w-4xl mx-auto">
                <div class="flex items-center gap-4 mb-8">
                    <div class="p-3 bg-red-500/20 rounded-xl text-red-400"><i class="fas fa-file-pdf text-xl"></i></div>
                    <h2 class="text-2xl font-bold">Ø±ÙØ¹ Ù…Ù„Ø§Ø²Ù… ÙˆÙ…Ù„ÙØ§Øª PDF</h2>
                </div>
                <form id="pdfForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select id="pdf-grade" class="w-full p-4" onchange="updateLessonList('pdf')">
                                <option value="1-prep">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="2-prep">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="3-prep">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                                <option value="1-sec">1 Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="2-sec">2 Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="3-sec">3 Ø«Ø§Ù†ÙˆÙŠ</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±</label>
                            <select id="pdf-month" class="w-full p-4 month-selector" onchange="updateLessonList('pdf')"></select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm text-slate-400 mr-2">Ø±Ø¨Ø· Ø¨Ù…Ø­Ø§Ø¶Ø±Ø© (Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©)</label>
                            <select id="pdf-lesson" class="w-full p-4 lesson-loader">
                                <option value="general">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©...</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-slate-400 mr-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù (Ù…Ø«Ù„Ø§Ù‹: Ù…Ù„Ø²Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)</label>
                        <input type="text" id="pdf-title" class="w-full p-4">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-slate-400 mr-2">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù (Google Drive / Direct)</label>
                        <input type="text" id="pdf-url" class="w-full p-4" placeholder="https://drive.google.com/...">
                    </div>
                    <button type="submit" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold rounded-2xl transition shadow-lg shadow-red-600/20">
                        <i class="fas fa-cloud-upload-alt ml-2"></i> Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù†
                    </button>
                </form>
            </div>
        </div>

        <div id="codes" class="section">
            <div class="glass-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold italic text-indigo-400 underline decoration-indigo-500/30 underline-offset-8">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="no-print p-3 bg-slate-700 hover:bg-slate-600 rounded-xl transition text-sm"><i class="fas fa-print"></i></button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <select id="c-grade" class="p-3">
                        <optgroup label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ©">
                            <option value="1-prep">1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="2-prep">2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="3-prep">3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        </optgroup>
                        <optgroup label="Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©">
                            <option value="1-sec">1 Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="2-sec">2 Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="3-sec">3 Ø«Ø§Ù†ÙˆÙŠ</option>
                        </optgroup>
                    </select>
                    <select id="c-month" class="p-3 month-selector"></select>
                    <select id="c-branch" class="p-3">
                        <option value="Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ">Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ ÙƒØ§Ù…Ù„</option>
                        <option value="Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©</option>
                    </select>
                    <input type="number" id="c-num" value="50" class="p-3" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                </div>
                
                <button onclick="generateCodesServer()" id="c-btn" class="w-full py-4 bg-purple-600 hover:bg-purple-700 rounded-2xl font-bold shadow-xl shadow-purple-600/20 transition mb-10">
                    <i class="fas fa-magic ml-2"></i> ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>

                <div id="codes-box" style="display:none;" class="print-area">
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3" id="codes-list"></div>
                </div>
            </div>
        </div>

        <div id="students" class="section">
            <div class="glass-card p-8 overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                    <h2 class="text-2xl font-bold">ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª ğŸ“Š</h2>
                    <div class="flex gap-1 bg-white/5 p-1 rounded-xl border border-white/10 overflow-x-auto">
                        <button onclick="filterStudentsByGrade('all')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold active bg-indigo-600">Ø§Ù„ÙƒÙ„</button>
                        <button onclick="filterStudentsByGrade('1-prep')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">1 Ø¹</button>
                        <button onclick="filterStudentsByGrade('2-prep')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">2 Ø¹</button>
                        <button onclick="filterStudentsByGrade('3-prep')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">3 Ø¹</button>
                        <button onclick="filterStudentsByGrade('1-sec')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">1 Ø«</button>
                        <button onclick="filterStudentsByGrade('2-sec')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">2 Ø«</button>
                        <button onclick="filterStudentsByGrade('3-sec')" class="grade-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10">3 Ø«</button>
                    </div>
                    <input type="text" id="studentSearch" onkeyup="searchStudent()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." class="p-2 text-sm w-64 border-white/5">
                </div>
                
                <div class="overflow-x-auto">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</th><th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th><th>Ø¢Ø®Ø± Ø¯Ø±Ø¬Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="students-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="absent" class="section">
            <div class="glass-card p-8 overflow-hidden">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
                    <h2 class="text-2xl font-bold text-red-400">ÙƒØ´Ù Ø§Ù„ØºÙŠØ§Ø¨ ( Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª) âš ï¸</h2>
                    <div class="flex gap-1 bg-white/5 p-1 rounded-xl border border-white/10 overflow-x-auto">
                        <button onclick="selectAbsentGrade('1-prep')" class="absent-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 border border-white/5">1 Ø¹</button>
                        <button onclick="selectAbsentGrade('2-prep')" class="absent-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 border border-white/5">2 Ø¹</button>
                        <button onclick="selectAbsentGrade('3-prep')" class="absent-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 border border-white/5">3 Ø¹</button>
                        <button onclick="selectAbsentGrade('1-sec')" class="absent-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 border border-white/5">1 Ø«</button>
                        <button onclick="selectAbsentGrade('2-sec')" class="absent-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 border border-white/5">2 Ø«</button>
                        <button onclick="selectAbsentGrade('3-sec')" class="absent-tab px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-white/10 border border-white/5">3 Ø«</button>
                    </div>
                </div>

                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs text-slate-400">Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…ØªØ§Ø¨Ø¹Ø© ØºÙŠØ§Ø¨Ù‡:</label>
                        <select id="absent-quiz-selector" onchange="filterAbsentByQuiz()" class="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-sm">
                            <option value="">   Ø§Ø®ØªØ§Ø± Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„...</option>
                        </select>
                    </div>
                    <div class="flex items-end pb-1">
                        <p id="absent-count" class="text-xs text-slate-400"></p>
                    </div>
                </div>

                <div id="absent-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="text-slate-500 text-center col-span-full py-10 italic">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙˆØ§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù„Ø¹Ø±Ø¶ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const token = localStorage.getItem('token');
        const gradesMap = {
            '1-prep': '1 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ', '2-prep': '2 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ', '3-prep': '3 Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ',
            '1-sec': '1 Ø«Ø§Ù†ÙˆÙŠ', '2-sec': '2 Ø«Ø§Ù†ÙˆÙŠ', '3-sec': '3 Ø«Ø§Ù†ÙˆÙŠ'
        };

        let currentQuestions = [];
        let allStudentsData = []; // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ÙÙ„ØªØ±Ø©
        let selectedAbsentGrade = "";

        window.onload = async () => {
            if (localStorage.getItem('role') !== 'admin') window.location.href = 'login.html';
            fillMonths();
            await loadStats();
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('ar-EG', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
        };

        function fillMonths() {
            const selectors = document.querySelectorAll('.month-selector');
            const months = ["Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±", "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ"];
            const currentMonthIdx = new Date().getMonth();
            const monthNameMapping = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
            
            selectors.forEach(sel => {
                sel.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
                sel.value = monthNameMapping[currentMonthIdx];
            });
        }

        async function updateLessonList(prefix) {
            const month = document.getElementById(`${prefix}-month`).value;
            const grade = document.getElementById(`${prefix}-grade`).value;
            const lessonSelect = document.getElementById(`${prefix}-lesson`);
            
            lessonSelect.innerHTML = `<option value="general">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ${month}...</option>`;
            
            try {
                const res = await fetch(`/api/admin/lessons-by-month?month=${encodeURIComponent(month)}&grade=${grade}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                let html = `<option value="standalone">${prefix === 'q' ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù…Ù†ÙØµÙ„' : 'Ù…Ù„Ù PDF Ø´Ø§Ù…Ù„ Ù…Ù†ÙØµÙ„'}</option>`;
                
                if(data.success && data.lessons && data.lessons.length > 0) {
                    data.lessons.forEach(lesson => {
                        html += `<option value="${lesson._id}">${lesson.title} (${lesson.branch})</option>`;
                    });
                }
                lessonSelect.innerHTML = html;
            } catch (err) {
                lessonSelect.innerHTML = `<option value="standalone">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³</option>`;
            }
        }

        function show(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            const targetSection = document.getElementById(id);
            const targetBtn = document.getElementById('btn-' + id);
            
            if(targetSection) targetSection.classList.add('active');
            if(targetBtn) {
                targetBtn.classList.add('active');
                document.getElementById('page-title').innerText = targetBtn.innerText.trim();
            }
            
            if(id === 'students' || id === 'absent') loadStudents();
            if(id === 'add-quiz') updateLessonList('q');
            if(id === 'add-pdf') updateLessonList('pdf');
        }

        function addQuestionToQuiz() {
            const text = document.getElementById('temp-q-text').value;
            const image = document.getElementById('temp-q-image').value;
            const explanation = document.getElementById('temp-q-explanation').value;
            const opts = [
                document.getElementById('temp-opt-0').value,
                document.getElementById('temp-opt-1').value,
                document.getElementById('temp-opt-2').value,
                document.getElementById('temp-opt-3').value
            ];
            const correctIndex = document.getElementById('temp-correct').value;

            if(!text || opts.some(o => !o) || correctIndex === "") {
                alert("Ø¨Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©");
                return;
            }
            const correctAnswerText = opts[parseInt(correctIndex)];
            currentQuestions.push({ question: text, questionImage: image, explanation: explanation, options: opts, correctAnswer: correctAnswerText });
            renderQuestionsPreview();
            ['temp-q-text','temp-q-image','temp-q-explanation','temp-opt-0','temp-opt-1','temp-opt-2','temp-opt-3','temp-correct'].forEach(id=>document.getElementById(id).value='');
        }

        function renderQuestionsPreview() {
            const container = document.getElementById('questions-container');
            container.innerHTML = currentQuestions.map((q, idx) => `
                <div class="p-4 bg-white/5 border border-white/10 rounded-xl relative group">
                    <button type="button" onclick="removeQuestion(${idx})" class="absolute left-4 top-4 text-red-400 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                    <p class="text-sm font-bold mb-2 text-indigo-300 flex items-center gap-2">
                        Ø³Ø¤Ø§Ù„ ${idx + 1}: ${q.question}
                        ${q.questionImage ? '<i class="fas fa-image text-xs text-slate-500"></i>' : ''}
                    </p>
                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-2">
                        ${q.options.map((o, i) => `<div class="${o === q.correctAnswer ? 'text-green-400 font-bold' : ''}">${String.fromCharCode(65+i)}) ${o}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function removeQuestion(index) { currentQuestions.splice(index, 1); renderQuestionsPreview(); }

        document.getElementById('lessonForm').onsubmit = async (e) => {
            e.preventDefault();
            const lessonData = { title: document.getElementById('l-title').value, videoUrl: document.getElementById('l-video').value, grade: document.getElementById('l-grade').value, branch: document.getElementById('l-branch').value, month: document.getElementById('l-month').value };
            try {
                const res = await fetch('/api/admin/add-lesson', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(lessonData) });
                const data = await res.json();
                alert(data.message);
                if(data.success) { e.target.reset(); loadStats(); }
            } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
        };

        document.getElementById('quizForm').onsubmit = async (e) => {
            e.preventDefault();
            if(currentQuestions.length === 0) { alert("Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); return; }
            const quizData = { title: document.getElementById('q-title').value, grade: document.getElementById('q-grade').value, month: document.getElementById('q-month').value, lessonId: document.getElementById('q-lesson').value, examDuration: document.getElementById('q-time').value, quiz: currentQuestions };
            try {
                const res = await fetch('/api/admin/add-quiz', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(quizData) });
                const data = await res.json();
                alert(data.message);
                if(data.success) { e.target.reset(); currentQuestions = []; renderQuestionsPreview(); }
            } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸"); }
        };

        document.getElementById('pdfForm').onsubmit = async (e) => {
            e.preventDefault();
            const pdfData = { title: document.getElementById('pdf-title').value, month: document.getElementById('pdf-month').value, lessonId: document.getElementById('pdf-lesson').value, grade: document.getElementById('pdf-grade').value, url: document.getElementById('pdf-url').value };
            try {
                const res = await fetch('/api/admin/add-pdf', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(pdfData) });
                const data = await res.json();
                alert(data.message);
                if(data.success) e.target.reset();
            } catch (err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹"); }
        };

        async function generateCodesServer() {
            const btn = document.getElementById('c-btn');
            btn.disabled = true;
            const config = { count: document.getElementById('c-num').value, grade: document.getElementById('c-grade').value, branch: document.getElementById('c-branch').value, month: document.getElementById('c-month').value };
            try {
                const res = await fetch('/api/admin/generate-codes', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(config) });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('codes-box').style.display = 'block';
                    document.getElementById('codes-list').innerHTML = data.generatedCodes.map(c => `<div class="p-3 bg-white/5 border border-white/10 rounded-xl text-center"><span class="block font-mono font-bold text-indigo-400 text-lg">${c}</span><span class="text-[10px] text-slate-500">${config.month}</span></div>`).join('');
                    loadStats();
                }
            } catch (err) { alert("ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯"); }
            finally { btn.disabled = false; }
        }

        async function loadStudents() {
            const table = document.getElementById('students-table');
            if(allStudentsData.length === 0) table.innerHTML = "<tr><td colspan='7' class='text-center py-10 opacity-50'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";
            try {
                const res = await fetch('/api/admin/students-report', { headers: { 'Authorization': `Bearer ${token}` } });
                allStudentsData = await res.json();
                renderFilteredStudents('all');
            } catch (err) { table.innerHTML = "<tr><td colspan='7' class='text-center'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>"; }
        }

        function filterStudentsByGrade(grade) {
            document.querySelectorAll('.grade-tab').forEach(btn => btn.classList.remove('bg-indigo-600'));
            event.target.classList.add('bg-indigo-600');
            renderFilteredStudents(grade);
        }

        function renderFilteredStudents(grade) {
            const table = document.getElementById('students-table');
            const filtered = grade === 'all' ? allStudentsData : allStudentsData.filter(s => s.grade === grade);
            table.innerHTML = filtered.map(s => `
                <tr class="${s.isSuspended ? 'opacity-60 bg-red-500/5' : ''}">
                    <td class="font-bold">${s.name}</td>
                    <td><span class="px-2 py-1 bg-indigo-500/20 text-indigo-300 rounded-lg text-xs">${gradesMap[s.grade] || s.grade}</span></td>
                    <td>${s.phone}</td>
                    <td>${s.parentPhone}</td>
                    <td class="text-green-400 font-bold">${s.lastGrade || '0'}%</td>
                    <td>
                        <span class="px-2 py-1 rounded-lg text-[10px] font-bold ${s.isSuspended ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                            ${s.isSuspended ? 'Ù…Ø¹Ù„Ù‚' : 'Ù†Ø´Ø·'}
                        </span>
                    </td>
                    <td>
                        <button onclick="toggleStudentStatus('${s._id}', ${s.isSuspended})" 
                                class="mx-1 p-2 rounded-lg transition ${s.isSuspended ? 'text-green-400 hover:bg-green-500/10' : 'text-orange-400 hover:bg-orange-500/10'}" 
                                title="${s.isSuspended ? 'ÙÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚' : 'ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø­Ø³Ø§Ø¨'}">
                            <i class="fas ${s.isSuspended ? 'fa-user-check' : 'fa-user-slash'}"></i>
                        </button>
                        <button class="text-indigo-400 mx-1"><i class="fas fa-edit"></i></button>
                        <button class="text-red-400 mx-1"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        async function toggleStudentStatus(studentId, currentStatus) {
            const action = currentStatus ? "ÙÙƒ ØªØ¹Ù„ÙŠÙ‚" : "ØªØ¹Ù„ÙŠÙ‚";
            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${action} Ø­Ø³Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ`)) return;

            try {
                const res = await fetch(`/api/admin/toggle-student-status/${studentId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ isSuspended: !currentStatus })
                });
                
                const data = await res.json();
                if(data.success) {
                    alert(`ØªÙ… ${action} Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
                    loadStudents();
                } else {
                    alert(data.message || "ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡");
                }
            } catch (err) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
            }
        }

        async function selectAbsentGrade(grade) {
            selectedAbsentGrade = grade;
            document.querySelectorAll('.absent-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const selector = document.getElementById('absent-quiz-selector');
            selector.innerHTML = `<option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ${gradesMap[grade]}...</option>`;

            try {
                const res = await fetch(`/api/admin/quizzes-by-grade?grade=${grade}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (data.success && data.quizzes.length > 0) {
                    let html = `<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ù…Ù† Ù‡Ù†Ø§ --</option>`;
                    data.quizzes.forEach(q => {
                        html += `<option value="${q._id}">${q.title} (${q.month})</option>`;
                    });
                    selector.innerHTML = html;
                } else {
                    selector.innerHTML = `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ</option>`;
                }
            } catch (err) {
                selector.innerHTML = `<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</option>`;
            }
            document.getElementById('absent-container').innerHTML = "<p class='col-span-full text-center text-slate-500 py-10'>ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù†Ø§Ù‹ Ø§Ù„Ø¢Ù†.</p>";
        }

        function filterAbsentByQuiz() {
            const quizId = document.getElementById('absent-quiz-selector').value;
            const container = document.getElementById('absent-container');
            
            if (!quizId) return;

            const absentStudents = allStudentsData.filter(student => {
                if (student.grade !== selectedAbsentGrade) return false;
                const hasTakenQuiz = student.scores && student.scores.some(s => 
                    (s.quizId && String(s.quizId) === String(quizId)) || 
                    (s.lessonId && String(s.lessonId) === String(quizId))
                );
                return !hasTakenQuiz;
            });

            document.getElementById('absent-count').innerText = `Ø¹Ø¯Ø¯ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ†: ${absentStudents.length} Ø·Ø§Ù„Ø¨`;

            if (absentStudents.length === 0) {
                container.innerHTML = "<p class='col-span-full text-center text-green-400 py-10'>Ù…Ù…ØªØ§Ø²!       ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù‡Ù†Ø§ Ø§Ù…ØªØ­Ù†ÙˆØ§ âœ…</p>";
                return;
            }

            container.innerHTML = absentStudents.map(s => `
                <div class="glass-card p-4 border-r-4 border-red-500 flex justify-between items-center bg-white/5">
                    <div>
                        <h4 class="font-bold text-sm">${s.name}</h4>
                        <p class="text-[10px] text-slate-400">Ù…ÙˆØ¨Ø§ÙŠÙ„: ${s.phone}</p>
                    </div>
                    <div class="flex gap-2">
                         <a href="https://wa.me/2${s.parentPhone}" target="_blank" class="p-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500 hover:text-white transition text-xs">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        <a href="tel:${s.parentPhone}" class="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500 hover:text-white transition text-xs">
                            <i class="fas fa-phone-alt"></i>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('stat-students').innerText = data.totalStudents || 0;
                    document.getElementById('stat-lessons').innerText = data.totalLessons || 0;
                    document.getElementById('stat-available').innerText = data.availableCodes || 0;
                    document.getElementById('stat-used').innerText = data.usedCodes || 0;
                }
            } catch (e) { }
        }

        function searchStudent() {
            let input = document.getElementById('studentSearch').value.toLowerCase();
            let rows = document.getElementById('students-table').getElementsByTagName('tr');
            for (let row of rows) { row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none"; }
        }

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>