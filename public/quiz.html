<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± | Mr Walid Mohamed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background: #020617; color: #fff; user-select: none; -webkit-user-select: none; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .option-card { background: #1e293b; border: 2px solid transparent; transition: all 0.3s; cursor: pointer; }
        .option-card:hover { border-color: #6366f1; background: #2d3748; }
        .option-card.selected { border-color: #6366f1; background: #312e81; box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
        .sticky-timer { position: sticky; top: 1rem; z-index: 50; }
        .progress-bar { height: 6px; background: #1e293b; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4f46e5, #818cf8); transition: width 0.4s ease; }
        @media print { body { display: none !important; } }
        .animate-fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Ø³ØªØ§ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ */
        .question-img { max-width: 100%; border-radius: 20px; border: 2px solid rgba(99, 102, 241, 0.2); margin-bottom: 1.5rem; cursor: zoom-in; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8" oncontextmenu="return false;">

<div class="max-w-3xl mx-auto">
    <div class="glass p-6 rounded-3xl mb-8 flex justify-between items-center sticky-timer shadow-2xl">
        <div>
            <h1 id="quizTitle" class="text-xl font-black text-indigo-400">ØªØ­Ù…ÙŠÙ„...</h1>
            <p id="questionCountText" class="text-xs text-slate-400 mt-1 font-bold italic">Ø³Ø¤Ø§Ù„ -- Ù…Ù† --</p>
        </div>
        <div class="text-left bg-slate-900/50 px-4 py-2 rounded-2xl border border-indigo-500/30">
            <div id="timer" class="text-2xl font-mono font-bold text-white">00:00</div>
            <div class="text-[10px] text-center text-indigo-300 font-bold uppercase tracking-widest">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
        </div>
    </div>

    <div class="progress-bar mb-8 mx-2">
        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
    </div>

    <div id="quizContainer">
        <div class="text-center p-20">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mx-auto"></div>
            <p class="mt-4 text-slate-400 font-bold">Ø¬Ø§Ø±ÙŠ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>
        </div>
    </div>

    <div id="quizControls" style="display: none;" class="flex flex-col sm:flex-row gap-4 mt-8">
        <button id="prevBtn" onclick="prevQuestion()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 font-black py-4 rounded-2xl transition-all border border-slate-700">
            <i class="fas fa-arrow-right ml-2"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
        </button>
        <button id="nextBtn" onclick="nextQuestion()" class="flex-[2] bg-indigo-600 hover:bg-indigo-500 text-white font-black py-4 rounded-2xl transition-all shadow-lg flex items-center justify-center gap-3">
            <span>Ø§Ù„ØªØ§Ù„ÙŠ</span> <i class="fas fa-arrow-left"></i>
        </button>
        <button id="submitBtn" onclick="confirmSubmit()" style="display: none;" 
            class="flex-[2] bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-2xl transition-all shadow-lg flex items-center justify-center gap-3">
            <i class="fas fa-paper-plane"></i> ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        </button>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const quizId = urlParams.get('id');
    const userId = localStorage.getItem('userId');
    const token = localStorage.getItem('token');
    
    let questions = [];
    let userAnswers = {};
    let timeLeft = 0;
    let timerInterval;
    let currentQuestionIdx = 0;

    async function fetchQuiz() {
        if (!token || !userId) { window.location.href = 'login.html'; return; }

        try {
            const res = await fetch(`/api/student/my-lessons/${userId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            if (!data.success) throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            let found = null;
            if (data.quizzes) found = data.quizzes.find(q => String(q._id) === String(quizId));
            if (!found && data.lessons) found = data.lessons.find(l => String(l._id) === String(quizId));

            if (!found) {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
                return;
            }

            if (found.alreadyTaken) {
                Swal.fire({
                    title: 'Ø¹Ø°Ø±Ø§Ù‹ ÙŠØ§ Ù‡Ù†Ø¯Ø³Ø©!',
                    text: 'Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ£Ø¯ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹.',
                    icon: 'warning',
                    confirmButtonText: 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©',
                    allowOutsideClick: false
                }).then(() => { window.location.href = 'student-dashboard.html'; });
                return;
            }

            questions = found.questions || found.quiz || [];

            if (questions.length === 0) {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'warning');
                return;
            }

            timeLeft = (found.examDuration || 30) * 60;
            document.getElementById('quizTitle').innerText = found.title || "Ø§Ø®ØªØ¨Ø§Ø± ØªÙØ§Ø¹Ù„ÙŠ";
            document.getElementById('quizControls').style.display = 'flex';
            
            renderQuestion();
            startTimer();
        } catch (e) {
            Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
        }
    }

    function renderQuestion() {
        const container = document.getElementById('quizContainer');
        const q = questions[currentQuestionIdx];
        if (!q) return;

        const qText = q.questionText || q.question || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ Ù„Ù„Ø³Ø¤Ø§Ù„";
        const qOptions = q.options || q.choices || [];
        const qImage = q.questionImage || ""; // Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯

        document.getElementById('questionCountText').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIdx + 1} Ù…Ù† ${questions.length}`;
        const progress = ((currentQuestionIdx + 1) / questions.length) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        let imageHtml = qImage ? `<img src="${qImage}" class="question-img shadow-lg" alt="Ø³Ø¤Ø§Ù„" onclick="window.open('${qImage}', '_blank')">` : "";

        container.innerHTML = `
            <div class="glass p-6 md:p-10 rounded-[40px] border border-white/5 animate-fade-in">
                ${imageHtml}
                <div class="text-xl md:text-2xl font-black mb-10 leading-relaxed text-right">
                    <span class="inline-flex items-center justify-center min-w-[3rem] h-12 px-2 bg-indigo-600 rounded-2xl text-lg ml-4 shadow-xl">Ø³${currentQuestionIdx+1}</span> 
                    ${qText}
                </div>
                <div class="grid gap-4">
                    ${qOptions.map((opt, optIdx) => `
                        <div onclick="selectOption(${currentQuestionIdx}, ${optIdx})" 
                            class="option-card p-6 rounded-[24px] flex items-center gap-5 group ${userAnswers[currentQuestionIdx] === optIdx ? 'selected' : ''}">
                            <span class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center text-sm font-black transition-colors ${userAnswers[currentQuestionIdx] === optIdx ? 'bg-indigo-600' : 'group-hover:bg-indigo-600'}">
                                ${String.fromCharCode(65 + optIdx)}
                            </span>
                            <span class="text-slate-200 group-hover:text-white font-bold text-lg transition-colors">${opt}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        updateNavigation();
    }

    function updateNavigation() {
        const isLast = currentQuestionIdx === questions.length - 1;
        document.getElementById('nextBtn').style.display = isLast ? 'none' : 'flex';
        document.getElementById('submitBtn').style.display = isLast ? 'flex' : 'none';
        
        const prevBtn = document.getElementById('prevBtn');
        if(currentQuestionIdx === 0) {
            prevBtn.classList.add('opacity-30', 'pointer-events-none');
        } else {
            prevBtn.classList.remove('opacity-30', 'pointer-events-none');
        }
    }

    function selectOption(qIdx, optIdx) {
        userAnswers[qIdx] = optIdx;
        renderQuestion();
    }

    function nextQuestion() {
        if (userAnswers[currentQuestionIdx] === undefined) {
            Swal.fire({ icon: 'warning', title: 'Ø¹Ø°Ø±Ø§Ù‹!', text: 'ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©', timer: 1500, showConfirmButton: false });
            return;
        }
        if (currentQuestionIdx < questions.length - 1) {
            currentQuestionIdx++;
            renderQuestion();
        }
    }

    function prevQuestion() {
        if (currentQuestionIdx > 0) {
            currentQuestionIdx--;
            renderQuestion();
        }
    }

    function startTimer() {
        const timerEl = document.getElementById('timer');
        timerInterval = setInterval(() => {
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            timerEl.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            if (timeLeft <= 60) timerEl.classList.add('text-red-500', 'animate-pulse');
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(true);
            }
            timeLeft--;
        }, 1000);
    }

    function confirmSubmit() {
        if (userAnswers[currentQuestionIdx] === undefined) {
             Swal.fire({ icon: 'warning', title: 'ØªÙ†Ø¨ÙŠÙ‡', text: 'ÙÙŠ Ø§Ø³Ø¦Ù„Ø© Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„ÙŠÙ‡Ø§!' });
             return;
        }
        Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…',
            text: "Ù‡Ù„ Ø±Ø§Ø¬Ø¹Øª Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¬ÙŠØ¯Ø§Ù‹ØŸ",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø³Ù„Ù… Ø§Ù„Ø¢Ù†',
            cancelButtonText: 'Ù…Ø±Ø§Ø¬Ø¹Ø©',
            confirmButtonColor: '#059669'
        }).then((res) => { if(res.isConfirmed) submitQuiz(); });
    }

    async function submitQuiz(isAuto = false) {
        clearInterval(timerInterval);
        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });

        const formattedAnswers = {};
        questions.forEach((q, idx) => {
            const opts = q.options || q.choices || [];
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù…Ø·Ø§Ø¨Ù‚ØªÙ‡ ÙˆØ­ÙØ¸Ù‡
            formattedAnswers[idx] = userAnswers[idx] !== undefined ? String(opts[userAnswers[idx]]).trim() : "N/A";
        });

        try {
            const response = await fetch('/api/student/submit-quiz', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({
                    quizId: quizId,
                    studentId: userId,
                    answers: formattedAnswers
                })
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    title: result.percentage >= 50 ? 'Ø²ÙŠ Ø§Ù„ÙÙ„! ğŸ‰' : 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                    html: `
                        <div class="py-4">
                            <div class="text-6xl font-black text-indigo-500 mb-2">${result.percentage}%</div>
                            <div class="text-slate-400 font-bold">Ø­ØµÙ„Øª Ø¹Ù„Ù‰ ${result.score} Ù…Ù† ${result.total}</div>
                            <p class="text-emerald-400 mt-4 text-sm font-bold italic">ØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ù„Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„ØªÙØ³ÙŠØ± Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</p>
                        </div>`,
                    icon: result.percentage >= 50 ? 'success' : 'info',
                    confirmButtonText: 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©',
                    allowOutsideClick: false
                }).then(() => window.location.href = 'student-dashboard.html');
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            Swal.fire('Ø®Ø·Ø£', error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸', 'error');
        }
    }

    window.onload = fetchQuiz;
</script>
</body>
</html>