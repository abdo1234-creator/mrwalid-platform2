<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Mr Walid Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="sidebar">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ©</h2>
        <button class="nav-btn active" onclick="showTab('lessons')">ğŸ“š Ø¥Ø¶Ø§ÙØ© Ø¯Ø±ÙˆØ³</button>
        <button class="nav-btn" onclick="showTab('codes')">ğŸ”‘ ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯</button>
        <button class="nav-btn" onclick="showTab('reports')">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <button class="nav-btn" onclick="logout()" style="color: #ff9999; margin-top: 30px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="content">
        <div id="lessonsSection" class="tab-content">
            <div class="card">
                <h3>Ø±ÙØ¹ Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡</h3>
                <form id="addLessonForm">
                    <div class="form-group">
                        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
                        <input type="text" id="lessonTitle" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø´ØªÙ‚Ø§Ù‚ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø«Ù„Ø«ÙŠØ©" required>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Embed URL)</label>
                        <input type="text" id="videoUrl" placeholder="https://www.youtube.com/embed/..." required>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex:1">
                            <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                            <select id="lessonGrade">
                                <option value="1_sec">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="2_sec">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                                <option value="3_sec">Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>Ø§Ù„ÙØ±Ø¹</label>
                            <select id="lessonBranch">
                                <option value="ØªÙØ§Ø¶Ù„">ØªÙØ§Ø¶Ù„</option>
                                <option value="Ø¬Ø¨Ø±">Ø¬Ø¨Ø±</option>
                                <option value="Ø§Ø³ØªØ§ØªÙŠÙƒØ§">Ø§Ø³ØªØ§ØªÙŠÙƒØ§</option>
                                <option value="Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§">Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label>Ø§Ù„Ø´Ù‡Ø±</label>
                            <input type="number" id="lessonMonth" min="1" max="12" value="10">
                        </div>
                    </div>
                    <button type="submit" id="saveLessonBtn" class="btn-action">Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ ÙˆÙ†Ø´Ø±Ù‡</button>
                </form>
            </div>
        </div>

        <div id="codesSection" class="tab-content" style="display:none">
            <div class="card">
                <h3>ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø´Ø­Ù† Ø´Ù‡Ø±ÙŠ</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</label>
                        <input type="number" id="codesCount" value="50">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØµÙ</label>
                        <select id="codesGrade">
                            <option value="1_sec">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="2_sec">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="3_sec">Ø«Ø§Ù„Ø«Ø© Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù…ÙØªÙˆØ­</label>
                        <select id="codesBranch">
                            <option value="ØªÙØ§Ø¶Ù„">ØªÙØ§Ø¶Ù„</option>
                            <option value="Ø¬Ø¨Ø±">Ø¬Ø¨Ø±</option>
                            <option value="Ø§Ø³ØªØ§ØªÙŠÙƒØ§">Ø§Ø³ØªØ§ØªÙŠÙƒØ§</option>
                            <option value="Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§">Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒØ§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ù„Ø´Ù‡Ø± ÙƒØ§Ù…ØŸ</label>
                        <input type="number" id="codesMonth" value="10">
                    </div>
                </div>
                <button onclick="generateCodes()" id="genBtn" class="btn-action">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¢Ù†</button>
                <div id="codesList" class="code-display"></div>
            </div>
        </div>

        <div id="reportsSection" class="tab-content" style="display:none">
            <div class="card">
                <h3>Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„ØµÙ</th>
                            <th>Ø¢Ø®Ø± Ø¯Ø±Ø¬Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (localStorage.getItem('role') !== 'admin') window.location.href = 'login.html';

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + 'Section').style.display = 'block';
            event.target.classList.add('active');
            if(tabName === 'reports') loadReports();
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø±Ø³ Ù„Ù„Ø³ÙŠØ±ÙØ±
        document.getElementById('addLessonForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveLessonBtn');
            btn.disabled = true;

            const lessonData = {
                title: document.getElementById('lessonTitle').value,
                videoUrl: document.getElementById('videoUrl').value,
                grade: document.getElementById('lessonGrade').value,
                branch: document.getElementById('lessonBranch').value,
                month: document.getElementById('lessonMonth').value
            };

            const res = await fetch('/api/admin/add-lesson', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(lessonData)
            });
            
            const result = await res.json();
            alert(result.message);
            btn.disabled = false;
        };

        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        async function generateCodes() {
            const btn = document.getElementById('genBtn');
            const display = document.getElementById('codesList');
            btn.disabled = true;

            const bodyData = {
                count: document.getElementById('codesCount').value,
                grade: document.getElementById('codesGrade').value,
                branch: document.getElementById('codesBranch').value,
                month: document.getElementById('codesMonth').value
            };

            const res = await fetch('/api/admin/generate-codes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(bodyData)
            });

            const data = await res.json();
            if(data.success) {
                display.style.display = 'block';
                display.innerHTML = "<strong>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©:</strong><br>" + data.generatedCodes.join(' - ');
            }
            btn.disabled = false;
        }

        async function loadReports() {
            const tbody = document.getElementById('studentsTableBody');
            const res = await fetch('/api/admin/students-report', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            tbody.innerHTML = data.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.phone}</td>
                    <td>${s.grade}</td>
                    <td>${s.lastScore || 'Ù„Ù… ÙŠÙ…ØªØ­Ù†'}</td>
                </tr>
            `).join('');
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>